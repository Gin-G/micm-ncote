.. _Multiple grid cells:

Multiple Grid Cells
===================

This tutorial will focus on running multiple grid cells. Because the 
:ref:`Rate constants` and :ref:`User defined rate constants` showed both configuring
the mechanism by hand and building with a configuration file, we will only show building
up the mechanism by hand for this tutorial. That mechanism will be a simple chapman mechanism.

.. math::

  O_{1}^{d} + N_2 &\longrightarrow O + N_2, &k_{1, \mathrm{arrhenius}} \\
  O_{1}^{d} + O_2 &\longrightarrow O + O_2, &k_{2, \mathrm{arrhenius}} \\
  O + O_3 &\longrightarrow 2O_2, &k_{3, \mathrm{arrhenius}} \\
  O + O_2 + M &\longrightarrow O_3 + M, &k_{4, \mathrm{arrhenius}} \\
  O_2 &\longrightarrow 2O, &k_{5, \mathrm{photolysis}} \\
  O_3 &\longrightarrow O_1^d +O_2,\qquad &k_{6, \mathrm{photolysis}} \\
  O_3 &\longrightarrow O +O_2, &k_{7, \mathrm{photolysis}} \\

We will use three grid cells. The second grid cells will have concentrations twice as large as the first grid cell.
The third grid cell will have concentrations half as large as the first grid cell. Initial conditions are things
that might be found in the atmosphere and the photolysis values are typical photolysis rates at noon.

If you're looking for a copy and paste, choose
the appropriate tab below and be on your way! Otherwise, stick around for a line by line explanation.

.. tabs::

    .. tab:: Build the Mechanism with the API

      .. literalinclude:: ../../../test/tutorial/test_multiple_grid_cells.cpp
        :language: cpp
        
Line-by-line explanation
------------------------

This mechanism only needs the arrhenius rate constant, the user defined rate constant (for photolysis rates)
and the rosenbrock solver.

.. literalinclude:: ../../../test/tutorial/test_multiple_grid_cells.cpp
  :language: cpp
  :lines: 1-9

After that, we'll use the ``micm`` namespace and setup a template alias so that we can instantiate the 
rosenbrock solver.

.. literalinclude:: ../../../test/tutorial/test_multiple_grid_cells.cpp
  :language: cpp
  :lines: 11-18

To create a :cpp:class:`micm::RosenbrockSolver`, we have to define a chemical system (:cpp:class:`micm::System`)
and our reactions, which will be a vector of :cpp:class:`micm::Process` We will use the species to define these as
well as a :cpp:class:`micm::Phase`.

.. literalinclude:: ../../../test/tutorial/test_multiple_grid_cells.cpp
  :language: cpp
  :lines: 84-94


With the species and gas phase, we can define all of our reactions

.. literalinclude:: ../../../test/tutorial/test_multiple_grid_cells.cpp
  :language: cpp
  :lines: 96-138


Now we can define our RosenbrockSolver. This time we'll form the reactions and chemical system in place.
Also, notice the ``false`` in our :cpp:class:`micm::RosenbrockSolverParameters`. This tells the solver
not to reorder the state variables. The reordering is an optimization that can minizie fill-in for some 
of the linear algebra operations. For this example, it's turned off so that the order of the state matches
the order the species are added to the gas phase.

.. literalinclude:: ../../../test/tutorial/test_multiple_grid_cells.cpp
  :language: cpp
  :lines: 140-143


Now we need to get a state and set the concentations of each of the species. In the 
":ref:`Rate constants set concentations`" section of the rate constants tutorial, 
we used a ``std::unordered_map<std::string, std::vector<double>>`` 
to set the concentrations. Here we will set the concentations by providing the :cpp:class:`micm::Species` objects.

.. literalinclude:: ../../../test/tutorial/test_multiple_grid_cells.cpp
  :language: cpp
  :lines: 145-165

Then we set the photolysis rates by creating a vector that is 3 elements long, one for each grid cell.

.. literalinclude:: ../../../test/tutorial/test_multiple_grid_cells.cpp
  :language: cpp
  :lines: 167-172

And lastly set the temperature and pressure for each grid cell.

.. literalinclude:: ../../../test/tutorial/test_multiple_grid_cells.cpp
  :language: cpp
  :lines: 174-179

Now we are ready to run the simulation.

.. literalinclude:: ../../../test/tutorial/test_multiple_grid_cells.cpp
  :language: cpp
  :lines: 181-204


And these are the results.

+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
|  time | grid |      O      |     O1D     |      O2     |      O3     |      M      |     Ar      |     N2      |     H2O     |     CO2     |
+=======+======+=============+=============+=============+=============+=============+=============+=============+=============+=============+
|   0   |  1   |   0.00e+00  |   0.00e+00  |   7.50e-01  |   8.10e-06  |   2.70e+25  |   3.34e-02  |   1.00e-10  |   1.19e-05  |   1.46e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
|   0   |  2   |   0.00e+00  |   0.00e+00  |   1.50e+00  |   1.62e-05  |   2.70e+25  |   6.68e-02  |   1.00e-10  |   2.38e-05  |   2.92e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
|   0   |  3   |   0.00e+00  |   0.00e+00  |   3.75e-01  |   4.05e-06  |   2.70e+25  |   1.67e-02  |   1.00e-10  |   5.95e-06  |   7.30e-04  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
|  200  |  1   |   7.62e-07  |   3.19e-08  |   7.50e-01  |   7.31e-06  |   2.70e+25  |   3.34e-02  |   1.00e-10  |   1.19e-05  |   1.46e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
|  200  |  2   |   1.52e-06  |   6.37e-08  |   1.50e+00  |   1.46e-05  |   2.70e+25  |   6.68e-02  |   1.00e-10  |   2.38e-05  |   2.92e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
|  200  |  3   |   3.81e-07  |   1.59e-08  |   3.75e-01  |   3.65e-06  |   2.70e+25  |   1.67e-02  |   1.00e-10  |   5.95e-06  |   7.30e-04  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
|  400  |  1   |   1.45e-06  |   6.06e-08  |   7.50e-01  |   6.59e-06  |   2.70e+25  |   3.34e-02  |   1.00e-10  |   1.19e-05  |   1.46e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
|  400  |  2   |   2.90e-06  |   1.21e-07  |   1.50e+00  |   1.32e-05  |   2.70e+25  |   6.68e-02  |   1.00e-10  |   2.38e-05  |   2.92e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
|  400  |  3   |   7.25e-07  |   3.03e-08  |   3.75e-01  |   3.30e-06  |   2.70e+25  |   1.67e-02  |   1.00e-10  |   5.95e-06  |   7.30e-04  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
|  600  |  1   |   2.07e-06  |   8.65e-08  |   7.50e-01  |   5.94e-06  |   2.70e+25  |   3.34e-02  |   1.00e-10  |   1.19e-05  |   1.46e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
|  600  |  2   |   4.14e-06  |   1.73e-07  |   1.50e+00  |   1.19e-05  |   2.70e+25  |   6.68e-02  |   1.00e-10  |   2.38e-05  |   2.92e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
|  600  |  3   |   1.03e-06  |   4.33e-08  |   3.75e-01  |   2.97e-06  |   2.70e+25  |   1.67e-02  |   1.00e-10  |   5.95e-06  |   7.30e-04  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
|  800  |  1   |   2.63e-06  |   1.10e-07  |   7.50e-01  |   5.36e-06  |   2.70e+25  |   3.34e-02  |   1.00e-10  |   1.19e-05  |   1.46e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
|  800  |  2   |   5.26e-06  |   2.20e-07  |   1.50e+00  |   1.07e-05  |   2.70e+25  |   6.68e-02  |   1.00e-10  |   2.38e-05  |   2.92e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
|  800  |  3   |   1.31e-06  |   5.50e-08  |   3.75e-01  |   2.68e-06  |   2.70e+25  |   1.67e-02  |   1.00e-10  |   5.95e-06  |   7.30e-04  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 1000  |  1   |   3.13e-06  |   1.31e-07  |   7.50e-01  |   4.84e-06  |   2.70e+25  |   3.34e-02  |   1.00e-10  |   1.19e-05  |   1.46e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 1000  |  2   |   6.27e-06  |   2.62e-07  |   1.50e+00  |   9.67e-06  |   2.70e+25  |   6.68e-02  |   1.00e-10  |   2.38e-05  |   2.92e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 1000  |  3   |   1.57e-06  |   6.55e-08  |   3.75e-01  |   2.42e-06  |   2.70e+25  |   1.67e-02  |   1.00e-10  |   5.95e-06  |   7.30e-04  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 1200  |  1   |   3.59e-06  |   1.50e-07  |   7.50e-01  |   4.36e-06  |   2.70e+25  |   3.34e-02  |   1.00e-10  |   1.19e-05  |   1.46e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 1200  |  2   |   7.18e-06  |   3.00e-07  |   1.50e+00  |   8.72e-06  |   2.70e+25  |   6.68e-02  |   1.00e-10  |   2.38e-05  |   2.92e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 1200  |  3   |   1.79e-06  |   7.50e-08  |   3.75e-01  |   2.18e-06  |   2.70e+25  |   1.67e-02  |   1.00e-10  |   5.95e-06  |   7.30e-04  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 1400  |  1   |   4.00e-06  |   1.67e-07  |   7.50e-01  |   3.93e-06  |   2.70e+25  |   3.34e-02  |   1.00e-10  |   1.19e-05  |   1.46e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 1400  |  2   |   8.00e-06  |   3.34e-07  |   1.50e+00  |   7.87e-06  |   2.70e+25  |   6.68e-02  |   1.00e-10  |   2.38e-05  |   2.92e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 1400  |  3   |   2.00e-06  |   8.36e-08  |   3.75e-01  |   1.97e-06  |   2.70e+25  |   1.67e-02  |   1.00e-10  |   5.95e-06  |   7.30e-04  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 1600  |  1   |   4.37e-06  |   1.83e-07  |   7.50e-01  |   3.55e-06  |   2.70e+25  |   3.34e-02  |   1.00e-10  |   1.19e-05  |   1.46e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 1600  |  2   |   8.74e-06  |   3.65e-07  |   1.50e+00  |   7.10e-06  |   2.70e+25  |   6.68e-02  |   1.00e-10  |   2.38e-05  |   2.92e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 1600  |  3   |   2.18e-06  |   9.13e-08  |   3.75e-01  |   1.77e-06  |   2.70e+25  |   1.67e-02  |   1.00e-10  |   5.95e-06  |   7.30e-04  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 1800  |  1   |   4.70e-06  |   1.97e-07  |   7.50e-01  |   3.20e-06  |   2.70e+25  |   3.34e-02  |   1.00e-10  |   1.19e-05  |   1.46e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 1800  |  2   |   9.40e-06  |   3.93e-07  |   1.50e+00  |   6.40e-06  |   2.70e+25  |   6.68e-02  |   1.00e-10  |   2.38e-05  |   2.92e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 1800  |  3   |   2.35e-06  |   9.83e-08  |   3.75e-01  |   1.60e-06  |   2.70e+25  |   1.67e-02  |   1.00e-10  |   5.95e-06  |   7.30e-04  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 2000  |  1   |   5.00e-06  |   2.09e-07  |   7.50e-01  |   2.89e-06  |   2.70e+25  |   3.34e-02  |   1.00e-10  |   1.19e-05  |   1.46e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 2000  |  2   |   1.00e-05  |   4.18e-07  |   1.50e+00  |   5.78e-06  |   2.70e+25  |   6.68e-02  |   1.00e-10  |   2.38e-05  |   2.92e-03  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
| 2000  |  3   |   2.50e-06  |   1.05e-07  |   3.75e-01  |   1.44e-06  |   2.70e+25  |   1.67e-02  |   1.00e-10  |   5.95e-06  |   7.30e-04  |
+-------+------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+-------------+
